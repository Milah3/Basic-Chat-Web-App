<!doctype html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{% block title %}Basic Chat Web App!!!{% endblock %} - Flaskr</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css"
        integrity="sha512-5fsy+3xG8N/1PV5MIJz9ZsWpkltijBI48gBzQ/Z2eVATePGHOkMIn+xTDHIfTZFVb9GMpflF2wOWItqxAP2oLQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet"
        type="text/css">
</head>

<body>
    <section class="content">
        {% block content %}{% endblock %}
    </section>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- <script src="{{url_for('static', filename='run.js')}}"></script> -->
    <!-- <script type="text/javascript" src="//cdn.socket.io/4.4.1/socket.io.min.js"></script> -->

    <script>
        
        $(document).ready(() => {
            try {
                var username = prompt('Welcome to the groupchat. What should we call you?')
                
                var socket = new WebSocket('ws://localhost:5000/echo')
            } catch (error) {
                alert('Error connecting websocket. Please reload the url. Else, contact the developer.')
            }

            socket.addEventListener('open', (event) => {
                console.log('Websocket connection opened!')
                socket.send(`new_user ${username}`)

            })
    
            socket.addEventListener('message', (event) => {
                
                if (event.data.includes('new_user')) {
                    new_user = event.data.replace(`{'msg': 'new_user', 'user': '`, '').replace(`'}`, '')

                    // MODAL TO TELL ABOUT NEW USER!
                    $('#modal').fadeIn('slow')
                    modal = document.createElement('button')
                    modal.innerText = `${new_user} has entered the chat`
                    modal.id = 'modal'
                    document.body.append(modal)
                    
                    setTimeout(() => {
                        $('#modal').fadeOut('slow')
                    }, 5000)
                }

                const usrbox = document.createElement('div')
                usrbox.classList.add('container', 'userbox', 'row')
                usrbox.id = 'usrbox'

                const usrname = document.createElement('div')
                usrname.classList.add('usrname', 'two')
                usrname.innerHTML = `<strong>${event.data['user']}</strong>`
                
                const usermsg = document.createElement('div')
                usermsg.classList.add('usermsg', 'ten')
                usermsg.innerText = event.data['msg']

                
                
                usrbox.append(usrname, usermsg)

                const chatbox = document.getElementById('chatbox')
                chatbox.append(usrbox)

                // const message = document.getElementById('msg');
                // console.log(message.value);
                
            })
    
            socket.addEventListener('close', (event) => {
                
    
            })

            $('#send').bind('click', function(e) {
                e.preventDefault();
                const message = document.getElementById('msg');
                
                socket.send(message.value); 
                message.value = '';
            });
        
            })

    </script>
</body>

</html>